<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>正念放松</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/swiper-4.2.2.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/global.css?v=1"/>
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
	</head>
	<body>
		<div id="downLoadLine">
			<img src="images/wxLogo.png"/>
			<a onclick="more()">下载APP</a>
		</div>
		
		<div class="playRelax">
			<div class="relaxMusic">
				<h1></h1>
				<div class="progressBar">
					<div>
						<em></em>
					</div>
				</div>
				<p class="currentTime"></p>
				<p class="totalTime"></p>
				<em class="relaxPlay1"></em>
			</div>

			<div class="relaxLoop">
				<div class="swiper-container" id="relaxLoop">
					<div class="swiper-wrapper">
						<!-- <div class="swiper-slide">
							<a class="relax-on">1</a>
						</div>
						<div class="swiper-slide">
							<a>2</a>
							<em></em>
						</div>
						<div class="swiper-slide">
							<a>3</a>
							<em></em>
							<img src='images/relaxLock.png' />
						</div> -->
					</div>
				</div>
			</div>

			<audio src="" id="audio"></audio>
		</div>
		
		
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/fastclick.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/swiper-4.2.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script src="js/index.js?v=20180115" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">

			function relaxClassList(coursesId,id){
				$.ajax({
			        url: apiUrl+"/sce_homepage/fm_list",
			        type: "post",
			        data: {coursesId:coursesId},
			        dataType: "json",
			        // async:false,
			        success: function(data) {
			        	if(data.success){
			                if(data.code == "2000"){
			                	var data = data.data;

								var fmName = "";
								var fmUrl = "";
								var html = "";
								$.each(data, function(i,item) {
									var playing = "";
									if (id == item.id) {
										fmName = item.title;
										fmUrl = item.fmUrl;
										playing = "relax-on";
									}

									var relaxNum = i+1;

									var relaxLine = "";
									if (i > 0) {
										relaxLine = "<em></em>";
									}

									var relaxLock = "";
									var isLock = "";
									if (i > 1) {
										isLock = " isLock";
										relaxLock = "<img src='images/relaxLock.png' />"
									}
									
									html += "<div class='swiper-slide"+isLock+"'>"+
										"<a class='"+playing+"' data-id='"+item.id+"'>"+relaxNum+"</a>"+relaxLine+relaxLock+
									"</div>"
								});

								$(".relaxMusic h1").text(fmName);
								$("#audio").attr("src",fmUrl);
			                	audioObj = $("#audio")[0];
			                	if (isWeChat()) {
			                		document.addEventListener("WeixinJSBridgeReady", function () { 
				                		audioObj.play();
				                		audioObj.pause();
								        getTime();
								    }, false); 
			                	} else {
			                		getTime();
			                	}


								$("#relaxLoop .swiper-wrapper").html(html);



			                }else{
			                	
			                }
			            }
			        }
			    });
			}


			function relaxDetail(id){
				$.ajax({
			        url: apiUrl+"/sce_homepage/sce_fm_courses",
			        type: "post",
			        data: {id:id},
			        dataType: "json",
			        // async:false,
			        success: function(data) {
			        	if(data.success){
			                if(data.code == "2000"){
			                	var data = data.data[0];
								
								var reTag = /<(?:.|\s)*?>/g;
								var shortCont = data.detail.replace(reTag,"");

						
								locationUrl = apiUrl+"/jsp/ffxl/share/relaxDetail.html?id="+id;
								wxtitle = "我从万心社推荐一门有用的正念课程给你："+data.coursesName;
								wximgUrl= data.img;
								wxdesc = shortCont;
								wxShare(locationUrl,wxtitle,wximgUrl,wxdesc);
			                }else{
			                	
			                }
			            }
			        }
			    });
			}

			function formatSeconds(value) {  
			    var theTime = parseInt(value);// 秒  
			    var theTime1 = 0;// 分  
				var result = "";
			    if(theTime > 60) {  
			        theTime1 = parseInt(theTime/60);  
			        theTime = parseInt(theTime%60);  
		            if(theTime1 > 60) {  
		            	theTime1 = parseInt(theTime1%60);  
		            }  
			    }  
				if (parseInt(theTime)<10) {
					result = "00:0"+parseInt(theTime); 
				} else{
					result = "00:"+parseInt(theTime); 
				}
		        
		        if(theTime1 > 0) {
					if (theTime1<10) {
						if (parseInt(theTime)<10) {
							result = "0"+parseInt(theTime1)+":0"+parseInt(theTime); 
						} else{
							result = "0"+parseInt(theTime1)+":"+parseInt(theTime); 
						}
					} else{
						if (parseInt(theTime)<10) {
							result = parseInt(theTime1)+":0"+parseInt(theTime); 
						} else{
							result = parseInt(theTime1)+":"+parseInt(theTime); 
						}
					}
		        }  
			    return result;  
			}  
			
			
			function getTime() {
	            setTimeout(function () {  
	                totalTime = audioObj.duration;
	                if(isNaN(totalTime)){
	                	play = false;
	                    getTime();  
	                }  
	                else{  
	                    play = true;
	                    
					    var totalTimeF =  audioObj.duration.toFixed(0);
					    $(".currentTime").text(formatSeconds(currentTime));
						$(".totalTime").text(formatSeconds(totalTimeF)); 
						
	                }  
	            }, 10);  
	        }  
			
			
			var totalTime = "";
			var currentTime = 0;
			var audioObj;
			var play = false;

			var audioObj;

			var locationUrl = "";
			var wxtitle = "";
			var wximgUrl = "";
			var wxdesc = "";
			
			$(function(){
				var coursesId = getQueryString("coursesId");
				var id = getQueryString("id");
				relaxClassList(coursesId,id);
				relaxDetail(coursesId)


				var relaxSwiper = new Swiper('#relaxLoop',{
					observer:true, //修改swiper自己或子元素时，自动初始化swiper
					observeParents:true,
					freeMode : true,
					slidesPerView: 'auto'
				})  


				var timer = "";
				$(".relaxMusic>em").click(function(){
					if (play) {
						if ($(this).hasClass("relaxPlay1")) {
							$(this).removeClass("relaxPlay1").addClass("relaxPlay2");
							audioObj.play();
							timer = setInterval(function(){
								if (currentTime == totalTime) {
									clearInterval(timer);
									$(".currentTime").text(formatSeconds(totalTime));
									return false;
								}
								$(".currentTime").text(formatSeconds(currentTime.toFixed(0)));
								$(".progressBar div").css("width",currentTime*100/totalTime+"%");
								
							},500)
						} else {
							$(this).removeClass("relaxPlay2").addClass("relaxPlay1");
							audioObj.pause();
							clearInterval(timer);
						}
					}
					
				})
				
				
				$("#audio").on("ended",function(){
					$(".relaxMusic>em").removeClass("relaxPlay2").addClass("relaxPlay1");
					
				});
				
				
				$("#audio").on("timeupdate",function(){
					currentTime = audioObj.currentTime;
				})
				
				
				$(".progressBar").click(function(e){
					var progressBarW = $(this).width();
					var offsetL = $(this).offset().left;
					var distance = e.pageX-offsetL;
					var percent = distance/progressBarW
					audioObj.currentTime = totalTime*percent;
					var currentTimeChange = totalTime*percent;
					$(".currentTime").text(formatSeconds(currentTimeChange.toFixed(0)));
					$(".progressBar div").css("width",currentTimeChange*100/totalTime+"%");
				})


				$("#relaxLoop").on("click","a",function(){
					if (!$(this).parent().hasClass("isLock")) {
						var relaxId = $(this).data("id");
						location.href="playRelax.html?coursesId="+coursesId+"&id="+relaxId;
					}
				})

				$("body").on("click",".isLock",function(){
					more();
				})
			})
		</script>
	</body>
</html>
