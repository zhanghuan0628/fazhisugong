
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>排行榜</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/swiper-4.2.2.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/mescroll.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/team.css?v=2"/>
	</head>
	<body>

		<div class="swiper-container rankingDetail" id="popularRanking">
			<div class="swiper-pagination"></div>
			<div class="swiper-wrapper">
				<div class="swiper-slide" id="team">
					<div class="rankingBoard mescroll" id="teamList">
						<ul>

						</ul>
					</div>
					
				</div>
				<div class="swiper-slide" id="personal">
					<div class="rankingBoard mescroll" id="personalList">
						<ul>

						</ul>
					</div>
				</div>
			</div>
		</div>

		
		
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/swiper-4.2.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mescroll.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/fastclick.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/index.js?v=20180423" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			// 团队答题榜
			function teamPraiseph(userId,actBannerId,teamStatus,page){
				$.ajax({
			        url: apiUrl+"/ans_tem/team_praiseph",
			        type: "post",
			        data: {userId:userId,actBannerId:actBannerId,pageSize:10,pageNo:page.num},
			        dataType: "json",
			        async:false,
			        success: function(data) {
			        	if(data.success){
			                if(data.code == "2000"){
								if (teamStatus != "unTeam") {
									var selfData = eval("("+data.module+")");
									var hasPraise = "";
									if (selfData.extPraise == "1") {
										hasPraise = " hasPraise";
									}
									var rankNum = "";
									if (selfData.ranking == "1") {
										rankNum = "<img class='rankImg' src='images/rank1.png' />"
									} else if (selfData.ranking == "2") {
										rankNum = "<img class='rankImg' src='images/rank2.png' />"
									} else if (selfData.ranking == "3") {
										rankNum = "<img class='rankImg' src='images/rank3.png' />"
									} else if (selfData.ranking == "未上榜") {
										rankNum = "<i style='font-size:1rem'>"+selfData.ranking+"</i>"
									} else {
										rankNum = "<i>"+selfData.ranking+"</i>"
									}
									var self = "<div class='selfRank'>"+rankNum+
											"<h1>"+selfData.tName+"</h1>"+
											"<div class='boardPopular selfPopular'>"+
												"<em class='popularBtn"+hasPraise+"'><img src='images/praiseLight.png' /></em>"+
												"<span>"+selfData.ansCount+"</span>"+
											"</div>"+
										"</div>";

									$("#popularRanking #team .rankingBoard .selfRank").remove();
									$("#popularRanking #team .rankingBoard").prepend(self);
								}
						
								

			                	var data = data.data.dataList;

								teamMescroll.endByPage(data.length, data.totalPage);

			                	var html = "";
								$.each(data, function(i,item) {
									var teamHasPraise = "";
									if (item.extPraise == "1") {
										teamHasPraise = " hasPraise";
									}
									var rankNum = "";
									if (item.ranking == "1") {
										rankNum = "<img class='rankImg' src='images/rank1.png' />"
									} else if (item.ranking == "2") {
										rankNum = "<img class='rankImg' src='images/rank2.png' />"
									} else if (item.ranking == "3") {
										rankNum = "<img class='rankImg' src='images/rank3.png' />"
									} else {
										rankNum = "<i>"+item.ranking+"</i>"
									}
									html += "<li data-tid='"+item.tId+"'>"+rankNum+
										"<h1>"+item.tName+"</h1>"+
										"<div class='boardPopular'>"+
											"<em class='popularBtn"+teamHasPraise+"'><img src='images/praiseLight.png' /></em>"+
											"<span>"+item.ansCount+"</span>"+
										"</div>"+
									"</li>"
								})

								if (page.num == 1) {
									$("#popularRanking #team .rankingBoard ul").empty();
								}
								$("#popularRanking #team .rankingBoard ul").append(html);
								
			                }else{
			                	
			                }
			            }
			        }
			    });
			}


			// 个人答题榜
			function prePraiseph(userId,actBannerId,teamStatus,page){
				
				$.ajax({
			        url: apiUrl+"/ans_tem/pre_praiseph",
			        type: "post",
			        data: {userId:userId,actBannerId:actBannerId,pageSize:10,pageNo:page.num},
			        dataType: "json",
			        async:false,
			        success: function(data) {
			        	if(data.success){
			                if(data.code == "2000"){
								if (teamStatus != "unTeam") {
									var selfData = eval("("+data.module+")");
									var hasPraise = "";
									if (selfData.extPraise == "1") {
										hasPraise = " hasPraise";
									}
									var rankNum = "";
									if (selfData.ranking == "1") {
										rankNum = "<img class='rankImg' src='images/rank1.png' />"
									} else if (selfData.ranking == "2") {
										rankNum = "<img class='rankImg' src='images/rank2.png' />"
									} else if (selfData.ranking == "3") {
										rankNum = "<img class='rankImg' src='images/rank3.png' />"
									} else if (selfData.ranking == "未上榜") {
										rankNum = "<i style='font-size:1rem'>"+selfData.ranking+"</i>"
									} else {
										rankNum = "<i>"+selfData.ranking+"</i>"
									}

									var self = "<div class='selfRank'>"+rankNum+
											"<div class='boardUser'>"+
												"<img src='"+selfData.tImg+"' />"+
												"<span>"+selfData.tName+"</span>"+
											"</div>"+
											"<div class='boardPopular selfPopular'>"+
												"<em class='popularBtn"+hasPraise+"'><img src='images/praiseLight.png' /></em>"+
												"<span>"+selfData.ansCount+"</span>"+
											"</div>"+
										"</div>";
									
									$("#popularRanking #personal .rankingBoard .selfRank").remove();
									$("#popularRanking #personal .rankingBoard").prepend(self);
								}

			                	var data = data.data.dataList;

								personalMescroll.endByPage(data.length, data.totalPage);

			                	var html = "";
								$.each(data, function(i,item) {
									var teamHasPraise = "";
									if (item.extPraise == "1") {
										teamHasPraise = " hasPraise";
									}
									var rankNum = "";
									if (item.ranking == "1") {
										rankNum = "<img class='rankImg' src='images/rank1.png' />"
									} else if (item.ranking == "2") {
										rankNum = "<img class='rankImg' src='images/rank2.png' />"
									} else if (item.ranking == "3") {
										rankNum = "<img class='rankImg' src='images/rank3.png' />"
									} else {
										rankNum = "<i>"+item.ranking+"</i>"
									}

									html += "<li data-tid='"+item.tId+"'>"+rankNum+
										"<div class='boardUser'>"+
											"<img src='"+item.tImg+"' />"+
											"<span>"+item.tName+"</span>"+
										"</div>"+
										"<div class='boardPopular'>"+
											"<em class='popularBtn"+teamHasPraise+"'><img src='images/praiseLight.png' /></em>"+
											"<span>"+item.ansCount+"</span>"+
										"</div>"+
									"</li>"
								})

								if (page.num == 1) {
									$("#popularRanking #personal .rankingBoard ul").empty();
								}
								$("#popularRanking #personal .rankingBoard ul").append(html);
								
			                }else{
			                	
			                }
			            }
			        }
			    });
			}



			// 点赞个人
			function praisePerson(userId,beUserId,sceId,actBannerId,_this){
				$.ajax({
			        url: apiUrl+"/ans_tem/praise",
			        type: "post",
			        data: {userId:userId,beUserId:beUserId,sceId:sceId,actBannerId:actBannerId},
			        dataType: "json",
			        async:false,
			        success: function(data) {
			        	if(data.success){
			                if(data.code == "2000"){
								var praiseNum = parseInt(_this.siblings("span").text()) + 1;
								_this.siblings("span").text(praiseNum);
								_this.addClass("hasPraise");
								_this.find("img").show();
								setTimeout(function(){
									_this.find("img").hide();
								}, 1000);

								if (userId == beUserId) {
									if (_this.parent().hasClass("selfPopular")) {
										console.log(userId)
										$("#personalList ul li").each(function(){
											if ($(this).data("tid") == userId) {
												$(this).find(".boardPopular span").text(praiseNum);
												$(this).find(".popularBtn").addClass("hasPraise");
												$(this).find(".popularBtn").find("img").show();
												var $this = $(this);
												setTimeout(function(){
													$this.find(".popularBtn").find("img").hide();
												}, 1000);
											}
										});
									} else {
										$("#personalList .selfRank .boardPopular span").text(praiseNum);
										$("#personalList .selfRank .boardPopular em").addClass("hasPraise");

										$("#personalList .selfRank .boardPopular em img").show();
										setTimeout(function(){
											$("#personalList .selfRank .boardPopular em img").hide();
										}, 1000);
									}
								}
								
			                }else{
			                	
			                }
			            }
			        }
			    });
			}


			// 点赞团队
			function praiseTeam(userId,praiseTeamId,sceId,actBannerId,_this){
				$.ajax({
			        url: apiUrl+"/ans_tem/praise",
			        type: "post",
			        data: {userId:userId,teamId:praiseTeamId,sceId:sceId,actBannerId:actBannerId},
			        dataType: "json",
			        async:false,
			        success: function(data) {
			        	if(data.success){
			                if(data.code == "2000"){
								var praiseNum = parseInt(_this.siblings("span").text()) + 1;
								_this.siblings("span").text(praiseNum);
								_this.addClass("hasPraise");
								_this.find("img").show();
								setTimeout(function(){
									_this.find("img").hide();
								}, 1000);

								if (teamId == praiseTeamId) {
									if (_this.parent().hasClass("selfPopular")) {
										$("#teamList ul li").each(function(){
											if ($(this).data("tid") == teamId) {
												$(this).find(".boardPopular span").text(praiseNum);
												$(this).find(".popularBtn").addClass("hasPraise");
												$(this).find(".popularBtn").find("img").show();
												var $this = $(this);
												setTimeout(function(){
													$this.find(".popularBtn").find("img").hide();
												}, 1000);
											}
										});
									} else {
										$("#teamList .selfRank .boardPopular span").text(praiseNum);
										$("#teamList .selfRank .boardPopular em").addClass("hasPraise");

										$("#teamList .selfRank .boardPopular em img").show();
										setTimeout(function(){
											$("#teamList .selfRank .boardPopular em img").hide();
										}, 1000);
									}
								}
								
			                }else{
			                	
			                }
			            }
			        }
			    });
			}


	
			var teamMescroll;
			var personalMescroll;
			var teamId = "";

			$(function(){
				var userId =  getQueryString("userId");
				var actBannerId =  getQueryString("actBannerId");
				var teamStatus = getQueryString("teamStatus");
				var sceId = getQueryString("sceId");
				teamId = getQueryString("teamId");

				var naviSwiper = new Swiper('.rankingDetail',{
					observer:true, //修改swiper自己或子元素时，自动初始化swiper
					observeParents:true,
					pagination: {
						el: '.swiper-pagination',
						clickable: true,
						renderBullet: function (index, className) {
							switch(index){
								case 0:text='团队';break;
								case 1:text='个人';break;
							}
							return '<span class="' + className + '">' + text + '<em></em></span>';
						},
					}
				})  


				teamMescroll = new MeScroll("teamList", { 
					down: {
						callback: function (mescroll) { 
							mescroll.resetUpScroll(); 
						}
					},
					up: {
						auto:false,
						callback: function (page) { teamPraiseph(userId,actBannerId,teamStatus,page); }, 
						isBounce: false
					}
				});

				personalMescroll = new MeScroll("personalList", { 
					down: {
						callback: function (mescroll) { 
							mescroll.resetUpScroll(); 
						}
					},
					up: {
						auto:false,
						callback: function (page) { prePraiseph(userId,actBannerId,teamStatus,page); }, 
						isBounce: false
					}
				});


				// 点赞个人
				$("#personalList").on("click",".boardPopular",function(){
					if (!$(this).find(".popularBtn").hasClass("hasPraise")) {
						var _this = $(this).find(".popularBtn");
						if (_this.parent().hasClass("selfPopular")) {
							praisePerson(userId,userId,sceId,actBannerId,_this);
						} else {
							var beUserId = _this.parents("li").data("tid");
							praisePerson(userId,beUserId,sceId,actBannerId,_this);
						}
					}
					
				})


				// 点赞团队
				$("#teamList").on("click",".boardPopular",function(){
					if (!$(this).find(".popularBtn").hasClass("hasPraise")) {
						var _this = $(this).find(".popularBtn");
						if (_this.parent().hasClass("selfPopular")) {
							praiseTeam(userId,teamId,sceId,actBannerId,_this);
						} else {
							var praiseTeamId = _this.parents("li").data("tid");
							praiseTeam(userId,praiseTeamId,sceId,actBannerId,_this);
						}
					}
					
				})
				
				
			})
		</script>
	</body>
</html>
